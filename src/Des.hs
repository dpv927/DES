module Des 
  ( ip
  , ipInv 
  , e 
  , s )
  where

import MyBits(testBit, setBit)
import Data.Word(Word64, Word32, Word8)
import Data.Array


ipHelp :: [Int] -> Int -> Word64 -> Word64 -> Word64
ipHelp [] _ block _ = block
ipHelp (x:xs) destBit block initBlock = ipHelp xs (destBit+1) newBlock initBlock
  where 
    newBlock = if testBit initBlock x then 
      setBit block destBit
    else block


ipIndexes :: [Int]
ipIndexes = -- IP bit indexes order
  [ 57, 49, 41, 33, 25, 17, 09, 01,
    59, 51, 43, 35, 27, 19, 11, 03,
    61, 53, 45, 37, 29, 21, 13, 05,
    63, 55, 47, 39, 31, 23, 15, 07,
    56, 48, 40, 32, 24, 16, 08, 00,
    58, 50, 42, 34, 26, 18, 10, 02,
    60, 52, 44, 36, 28, 20, 12, 04,
    62, 54, 46, 38, 30, 22, 14, 06 ]


-- Initial Permutation (IP)
ip :: Word64 -> Word64
ip = ipHelp ipIndexes 0 0 


ipInvIndexes :: [Int]
ipInvIndexes = -- IP^-1 bit indexes
  [ 39, 07, 47, 15, 55, 23, 63, 31,
    38, 06, 46, 14, 54, 22, 62, 30,
    37, 05, 45, 13, 53, 21, 61, 29,
    36, 04, 44, 12, 52, 20, 60, 28,
    35, 03, 43, 11, 51, 19, 59, 27,
    34, 02, 42, 10, 50, 18, 58, 26,
    33, 01, 41, 09, 49, 17, 57, 25,
    32, 00, 40, 08, 48, 16, 56, 24 ]


-- Initial Permutation Inverse (IP^-1)
ipInv :: Word64 -> Word64
ipInv = ipHelp ipInvIndexes 0 0


eIndexes :: [Int]
eIndexes = -- E bit selection
  [ 31, 00, 01, 02, 03, 04, 
    03, 04, 05, 06, 07, 08,
    07, 08, 09, 10, 11, 12,
    11, 12, 13, 14, 15, 16,
    15, 16, 17, 18, 19, 20,
    19, 20, 21, 22, 23, 24,
    23, 24, 25, 26, 27, 28,
    27, 28, 29, 30, 31, 00 ]


-- Takes a 32 bit block and yields a block 
-- of 48 bits (as a 64 bit padded block)
e :: Word32 -> Word64 
e block = ipHelp eIndexes 0 0 (fromIntegral block :: Word64)


sRow :: [Int]
sRow = [0,1..15]

sTables :: Array Int (Array Int (Array Int Word8))
sTables = array (1,8) [
  (1, -- S1
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [14, 04, 13, 01, 02, 15, 11, 08, 03, 10, 06, 12, 05, 09, 00, 07]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [00, 15, 07, 04, 14, 02, 13, 01, 10, 06, 12, 11, 09, 05, 03, 08]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [04, 01, 14, 08, 13, 06, 02, 11, 15, 12, 09, 07, 03, 10, 05, 00]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [15, 12, 08, 02, 04, 09, 01, 07, 05, 11, 03, 14, 10, 00, 06, 13]])]),
  (2, -- S2
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [15, 01, 08, 14, 06, 11, 03, 04, 09, 07, 02, 13, 12, 00, 05, 10]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [03, 13, 04, 07, 15, 02, 08, 14, 12, 00, 01, 10, 06, 09, 11, 05]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [00, 14, 07, 11, 10, 04, 13, 01, 05, 08, 12, 06, 09, 03, 02, 15]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [13, 08, 10, 01, 03, 15, 04, 02, 11, 06, 07, 12, 00, 05, 14, 09]])]),
  (3, -- S3
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [10, 00, 09, 14, 06, 03, 15, 05, 01, 13, 12, 07, 11, 04, 02, 08]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [13, 07, 00, 09, 03, 04, 06, 10, 02, 08, 05, 14, 12, 11, 15, 01]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [13, 06, 04, 09, 08, 15, 03, 00, 11, 01, 02, 12, 05, 10, 14, 07]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [01, 10, 13, 00, 06, 09, 08, 07, 04, 15, 14, 03, 11, 05, 02, 12]])]),
  (4, -- S4
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [07, 13, 14, 03, 00, 06, 09, 10, 01, 02, 08, 05, 11, 12, 04, 15]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [13, 08, 11, 05, 06, 15, 00, 03, 04, 07, 02, 12, 01, 10, 14, 09]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [10, 06, 09, 00, 12, 11, 07, 13, 15, 01, 03, 14, 05, 02, 08, 04]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [03, 15, 00, 06, 10, 01, 13, 08, 09, 04, 05, 11, 12, 07, 02, 14]])]),
  (5, -- S5
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [02, 12, 04, 01, 07, 10, 11, 06, 08, 05, 03, 15, 13, 00, 14, 09]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [14, 11, 02, 12, 04, 07, 13, 01, 05, 00, 15, 10, 03, 09, 08, 06]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [04, 02, 01, 11, 10, 13, 07, 08, 15, 09, 12, 05, 06, 03, 00, 14]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [11, 08, 12, 07, 01, 14, 02, 13, 06, 15, 00, 09, 10, 04, 05, 03]])]),
  (6,  -- S6
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [12, 01, 10, 15, 09, 02, 06, 08, 00, 13, 03, 04, 14, 07, 05, 11]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [10, 15, 04, 02, 07, 12, 09, 05, 06, 01, 13, 14, 00, 11, 03, 08]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [09, 14, 15, 05, 02, 08, 12, 03, 07, 00, 04, 10, 01, 13, 11, 06]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [04, 03, 02, 12, 09, 05, 15, 10, 11, 14, 01, 07, 06, 00, 08, 13]])]),
  (7, -- S7 
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [04, 11, 02, 14, 15, 00, 08, 13, 03, 12, 09, 07, 05, 10, 06, 01]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [13, 00, 11, 07, 04, 09, 01, 10, 14, 03, 05, 12, 02, 15, 08, 06]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [01, 04, 11, 13, 12, 03, 07, 14, 10, 15, 06, 08, 00, 05, 09, 02]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [06, 11, 13, 08, 01, 04, 10, 07, 09, 05, 00, 15, 14, 02, 03, 12]])]),
  (8, -- S8
    array (0,2) [ 
      (0, array (0,15) [(i,j) | i <- sRow, j <- [13, 02, 08, 04, 06, 15, 11, 01, 10, 09, 03, 14, 05, 00, 12, 07]]),
      (1, array (0,15) [(i,j) | i <- sRow, j <- [01, 15, 13, 08, 10, 03, 07, 04, 12, 05, 06, 11, 00, 14, 09, 02]]),
      (2, array (0,15) [(i,j) | i <- sRow, j <- [07, 11, 04, 01, 09, 12, 14, 02, 00, 06, 10, 13, 15, 03, 05, 08]]),
      (3, array (0,15) [(i,j) | i <- sRow, j <- [02, 01, 14, 07, 04, 10, 08, 13, 15, 12, 09, 00, 03, 05, 06, 11]])])]


s' :: Word64 -> Int -> Word64 -> Word32
s' 0x3f _ block = fromIntegral block :: Word32
s' mask it block = 01

s :: Word64 -> Word32 
s = s' 0 0xfc0000000000


-- mask: 0b111111000000....
-- parar cuando mask == 0b111111
--
-- B = (mask & bloque) >> (48 - (6 + it))
-- row = (0x000001 & B) | ((0x100000 & B) >> 5)
-- col = (0x011110 & B) >> 1
-- result = ((sTables ! it) ! row) ! col
